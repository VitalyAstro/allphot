#!/bin/bash

ALLPHOT_EXEC_DIR="@LIBEXECDIR@/allphot"
ALLPHOT_OPT_DIR="@DATADIR@/allphot"

source ${ALLPHOT_EXEC_DIR}/options.bash
source ${ALLPHOT_EXEC_DIR}/recipes.bash

usage() {
    echo "Usage: allphot [OPTIONS] <fits images>"
    exit 1
}

OPTIND=1
field=allphot.$$
dict=

while getopts "d:f:h" opt; do
    case "${opt}" in
	d) dict="${OPTARG}";;
	f) field="${OPTARG}";;
	h) usage ;;
    esac
done
shift
[[ $# -eq 0 ]] && usage

for im in $*; do
    allphot_allstar_iterate ${im} ${dict}
done

ln -s *_process/*.{psf,als,ap,fits} .
ls -1 *.als | tail --lines=+2 > ${field}.list
allphot_daomatch $(ls -1 *.als | head -n1) ${field} ${field}.list
allphot_daomaster ${field}
allphot_allframe ${field}
